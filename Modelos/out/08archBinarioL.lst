     1                                  ;***************************************************************************
     2                                  ; fileBinary.asm
     3                                  ; Ejercicio que lee y escribe un archivo binario
     4                                  ; Objetivos
     5                                  ;	- manejo de archivo binario
     6                                  ;	- usar fopen (abrir)
     7                                  ;	- usar fread (leer)
     8                                  ;	- usar rewind (rebobinar)
     9                                  ;	- usar fwrite (escribir)
    10                                  ;	- usar fclose (cerrar)
    11                                  ; 
    12                                  ;***************************************************************************
    13                                  global		main
    14                                  extern		printf
    15                                  extern		puts
    16                                  extern		fopen
    17                                  extern		fwrite
    18                                  extern		rewind
    19                                  extern		fread
    20                                  extern		fclose
    21                                  
    22                                  section		.data
    23 00000000 30386172636869766F-     	fileName		db	"08archivo.dat",0
    23 00000009 2E64617400         
    24 0000000E 61622B00                	mode				db	"ab+",0		; modo append binary and read (actualizacion y lectura)
    25 00000012 4572726F7220656E20-     	msgErrOpen	db  "Error en apertura de archivo",0
    25 0000001B 617065727475726120-
    25 00000024 646520617263686976-
    25 0000002D 6F00               
    26                                  
    27                                  	registro1	times 0		db	""
    28 0000002F D007                    											dw	2000	;Se guarda en LITTLE ENDIAN D007 en memoria y cuando se copia en el archivo
    29 00000031 5269636172646F2020-     											db	"Ricardo   ",0
    29 0000003A 2000               
    30                                  	
    31                                  	registro	times 0 	db ""
    32 0000003C 0000                    	id									dw 0
    33 0000003E 2000<rep Ah>            	nombre		times 10	db " ",0
    34                                  	
    35 00000052 2535697C25730A0D00      	linea		db	"%5i|%s",10,13,0
    36                                  
    37                                  section		.bss
    38 00000000 ????????????????        	fileHandle	resq	1
    39                                  section		.text
    40                                  main:
    41 00000000 4883EC08                	sub		rsp,8
    42                                  ;	Abro archivo para actualizacion y lectura	
    43 00000004 48BF-                   	mov		rdi,fileName	;Parametro 1: dir nombre del archivo
    43 00000006 [0000000000000000] 
    44 0000000E 48BE-                   	mov		rsi,mode			;Parametro 2: dir string modo de apertura
    44 00000010 [0E00000000000000] 
    45 00000018 E8(00000000)            	call	fopen					;ABRE el archivo y deja el handle en EAX
    46                                  
    47 0000001D 4883F800                	cmp		rax,0					;Error en apertura?
    48 00000021 7F14                    	jg		openOk
    49                                  
    50                                  ;	Error apertura
    51 00000023 48BF-                   	mov		rdi,msgErrOpen
    51 00000025 [1200000000000000] 
    52 0000002D E8(00000000)            	call	puts
    53 00000032 E990000000              	jmp		endProg
    54                                  
    55                                  openOk:
    56 00000037 48890425[00000000]      	mov		[fileHandle],rax
    57                                  ;	Agrego un registro
    58 0000003F 48BF-                   	mov		rdi,registro1			;Parametro 1: dir area de memoria con datos a copiar
    58 00000041 [2F00000000000000] 
    59 00000049 BE0C000000              	mov		rsi,12						;Parametro 2: longitud del registro
    60 0000004E BA01000000              	mov		rdx,1							;Parametro 3: cantidad de registros
    61 00000053 488B0C25[00000000]      	mov		rcx,[fileHandle]	;Parametro 4: handle del archivo
    62 0000005B E8(00000000)            	call	fwrite						;ESCRIBO registro. Devuelve en rax la cantidad de bytes leidos
    63                                  
    64                                  ;	Rebobino al inicio del archivo	
    65 00000060 488B3C25[00000000]      	mov		rdi,[fileHandle]	;Parametro 1: handle del archivo
    66 00000068 E8(00000000)            	call	rewind						;REBOBINO al inicio del archivo
    67                                  
    68                                  ;	Leo un registro
    69                                  read:
    70 0000006D 48BF-                   	mov		rdi,registro			;Parametro 1: dir area de memoria donde se copia
    70 0000006F [3C00000000000000] 
    71 00000077 BE0C000000              	mov		rsi,12						;Parametro 2: longitud del registro
    72 0000007C BA01000000              	mov		rdx,1							;Parametro 3: cantidad de registros
    73 00000081 488B0C25[00000000]      	mov		rcx,[fileHandle]	;Parametro 4: handle del archivo
    74 00000089 E8(00000000)            	call	fread							;LEO registro. Devuelve en rax la cantidad de bytes leidos
    75                                  
    76 0000008E 4883F800                	cmp		rax,0				;Fin de archivo?
    77 00000092 7E26                    	jle		eof
    78                                  
    79                                  ;	Imprimo el registro en pantalla
    80 00000094 48BF-                   	mov		rdi,linea				;Parametro 1: dir del texto a imprimir por pantalla
    80 00000096 [5200000000000000] 
    81 0000009E 4829F6                  		sub rsi,rsi
    82 000000A1 668B3425[3C000000]      	mov		si,[id]					;Parametro 2: dato a ser formateado como numero entero decimal
    83 000000A9 48BA-                   	mov		rdx,nombre			;Parametro 3: dir dato a ser formateado como string
    83 000000AB [3E00000000000000] 
    84 000000B3 E8(00000000)            	call	printf
    85                                  	
    86 000000B8 EBB3                    	jmp		read
    87                                  
    88                                  eof:
    89 000000BA 488B3C25[00000000]      	mov		rdi,[fileHandle]	;Parametro 1: handle del archivo
    90 000000C2 E8(00000000)            	call	fclose
    91                                  endProg:	
    92 000000C7 4883C408                	add		rsp,8
    93 000000CB C3                      	ret
